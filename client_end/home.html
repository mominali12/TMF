<!doctype html>
<html lang="en">

<head>
    <title>Order-Management</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.23/css/dataTables.bootstrap.min.css">

</head>

<body>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

    <script src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.23/js/dataTables.bootstrap.min.js"></script>    

    <div class="container-fluid p-4">
        
        <div class="row p-4">
            <button id="completed_page_nav" type="button" class="btn btn-primary">Completed Orders</button>
        </div>

        <div class="row">
            <img id="storename" alt="Home Page">
        </div>
        
        <div class="row">
            <div class="col-md-4 p-4">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#colModal">
                    Add/Remove Column
                </button>
                <button type="button" class="btn btn-primary ml-4" data-toggle="modal" data-target="#rowModal">
                    Add Row
                </button>
                <button type="button" class="btn btn-success ml-4" onclick="submit()">
                    Save
                </button>
            </div>
            <div class="col-md-4 p-4">
                <table class="table table-bordered">
                    <thead>
                        <th colspan="4" style="text-align: center;">Status Legend</th>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="color:honeydew; background-color: rgb(0, 112, 192);">Not Started</td>
                            <td style="color:honeydew; background-color: rgb(255, 192, 0);">In Progress</td>
                            <td style="color:honeydew; background-color: rgb(255, 0, 0);">Delayed</td>
                            <td style="color:honeydew; background-color: rgb(0, 176, 80);">Complete</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <table id="mtable" class="table table-striped table-inverse table-responsive">
                    <thead>
                        <tr>
                            <th>▬</th>
                            <th>Customer</th>
                            <th>Product</th>
                            <th>Codes</th>
                            <th>Code Date</th>
                            <th>Design</th>
                            <th>Design Date</th>
                            <th>Design Approval</th>
                            <th>Design Approval Date</th>
                            <th>Send to Printer</th>
                            <th>Send to Printer Date</th>
                            <th>Proof Approval</th>
                            <th>Proof Approval Date</th>
                            <th>Shipping</th>
                            <th>Ship Date</th>
                            <th>Received</th>
                            <th>Received Date</th>
                            <th>Completed</th>
                            <th>Files</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
            </div>
        </div>
    </div>

      
    <!--////////////////////////////////////////////////////////////////////////////////////////////-->  
    <!--////////////////////////////////////// ADD ROW MODAL ///////////////////////////////////////-->  
    <!--////////////////////////////////////////////////////////////////////////////////////////////-->  

    <!-- The Modal -->
    <div class="modal" id="rowModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Add row</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
            
                <!-- Modal body -->
                <div class="modal-body">
                    <label for="customer_name">Customer Name</label>
                    <input id="row_modal_customer_name" class="form-control" id="customer_name" placeholder="Customer Name">
                    <label for="product_name">Product</label>
                    <input id="row_modal_product_name" class="form-control" id="product_name" placeholder="Product">
                </div>
            
                <!-- Modal footer -->
                <div class="modal-footer">
                    <button id="add_row_modal" type="button" class="btn btn-success" data-dismiss="modal">Add Row</button>
                </div>
        
            </div>
        </div>
    </div>

    <!--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-->  
    <!--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-->  
    <!--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-->  

    

    <!--//////////////////////////////////////////////////////////////////////////////////////////////////////-->  
    <!--///////////////////////////////////// ADD or REMOVE COLUMN MODAL /////////////////////////////////////-->  
    <!--//////////////////////////////////////////////////////////////////////////////////////////////////////-->  

    <!-- The Modal -->
    <div class="modal" id="colModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Add column</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
            
                <!-- Modal body -->
                <div class="modal-body">
                    <label for="column_name">Column title</label>
                    <input id="col_modal_column_name" class="form-control" id="customer_name" placeholder="Column Name">

                    <label for="general_dropdown">Column type</label>
                    <select class="form-control" name="general_dropdown" id="col_modal_select">
                        <option value="date">Date</option>
                        <option value="dropdown">Dropdown</option>
                    </select>
                </div>
            
                <!-- Modal footer -->
                <div class="modal-footer">
                    <button id="add_col_modal" type="button" class="btn btn-success" data-dismiss="modal">Add Column</button>
                    <button id="del_col_modal" type="button" class="btn btn-danger" data-dismiss="modal">Delete Column</button>
                </div>
        
            </div>
        </div>
    </div>

    <!--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-->  
    <!--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-->  
    <!--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-->  
 
    <script type="text/javascript">

        var user_identity = "" 

        $("#completed_page_nav").click(function(){
            location.replace("http://localhost:3000/home/completed");
        });

        // var text = '{ "CUSTOMER":"CUSTOMER", "PRODUCT":"PRODUCT", "Codes":"Codes", "CodeDate":"CodeDate", "Design":"Design", "DesignDate":"DesignDate", "DesignApproval":"DesignApproval", "DesignApprovalDate":"DesignApprovalDate", "SenttoPrinter":"SenttoPrinter", "SentDate":"SentDate", "ProofApproval":"ProofApproval", "ProofApprovalDate":"ProofApprovalDate", "Shipping":"Shipping", "ShipDate":"ShipDate", "Received":"Received", "ReceivedDate":"ReceivedDate", "Completed":"Completed", "Files":"Files", "Notes":"Notes"}';
        // var obj = JSON.parse(text);
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////// ADD ROW MODAL BUTTON ///////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        $('#add_row_modal').click(function () {
            if($('#row_modal_customer_name').val())
            {
                if($('#row_modal_product_name').val())
                {
                    $('#mtable tbody').append($("#mtable tbody tr:last").clone());
                    $('#mtable tbody tr:last td:nth-child(2)').html($('#row_modal_customer_name').val());
                    $('#mtable tbody tr:last td:nth-child(3)').html($('#row_modal_product_name').val());
                }
                else
                {
                    alert("Please enter product name");
                }
            }
            else
            {
                alert("Please enter customer name");
            }
        });

        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////// ADD COL ON CLICK FUNC ////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        $('#add_col_modal').click(function () {
            if ($('#col_modal_column_name').val()) {
                $('#mtable tr:first').append($("<th>"));
                $('#mtable tr').not(':first').append($("<td>"));    
                $('#mtable thead tr>th:last').html($('#col_modal_column_name').val());
                if($('#col_modal_select').val().localeCompare('date') === 0)
                {
                    $('#mtable tbody tr').each(function () { $(this).children('td:last').append(make_date_selector('')) });
                }
                else
                {
                    $('#mtable tbody tr').each(function () { $(this).children('td:last').append(make_drop_down('')) });
                }
            } else { alert('Enter Column Name'); }
        });

        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////// DELETE ROW FUNCTION ////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        function delete_row(e){
            $(e).closest("tr").remove();
        }

        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////// DELETE COL FUNCTION ////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        $('#del_col_modal').click(function delete_col() { 
            var tble = document.getElementById('mtable'); 
            var row = tble.rows; // Getting the rows 
            var check = false;
            var allowed = true;
            for (var i = 0; i < row[0].cells.length; i++) { 
  
                // Getting the text of columnName 
                var str = row[0].cells[i].innerHTML;
                str = str.toLowerCase();
                var userinput = $('#col_modal_column_name').val()
                userinput = userinput.toLowerCase()

                // If 'userinput' matches with the columnName  
                if (str.localeCompare(userinput) === 0) 
                {  
                    if(userinput.localeCompare("▬")===0)
                    {
                        break;
                    }
                    if(userinput.localeCompare("customer")===0)
                    {
                        alert("Customer's column can't be deleted,\nPlease choose some other column");
                        allowed=false;
                        break;
                    }
                    else
                    {
                        check=true;
                        for (var j = 0; j < row.length; j++) 
                        {
                            // Deleting the ith cell of each row 
                            row[j].deleteCell(i); 
                        } 
                    }
                }
            } 
            if(allowed)
            {
                
            }
            if (check)
            {
                alert("Column is removed from the table."); 
            }
            else
            {
                alert("Column not found"); 
            }
        });


        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////// make_drop_down FUNC ////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        function make_drop_down(selectedval)
        {
            
            if(selectedval.localeCompare("Completed")===0)
            {
                var dropdown = '<select class="form-control" name="general_dropdown" id="cars"'+'>'+
                '<option value="Not Started">Not Started</option'+'>'+
                '<option value="In Progress">In Progress</option'+'>'+
                '<option value="Delayed">Delayed</option'+'>'+
                '<option selected="selected" value="Completed">Completed</option'+'>'+'</select>';
            }
            else if(selectedval.localeCompare("In Progress")===0)
            {
                var dropdown = '<select class="form-control" name="general_dropdown" id="cars"'+'>'+
                '<option value="Not Started">Not Started</option'+'>'+
                '<option selected="selected" value="In Progress">In Progress</option'+'>'+
                '<option value="Delayed">Delayed</option'+'>'+
                '<option value="Completed">Completed</option'+'>'+'</select>';
            }
            else if(selectedval.localeCompare("Delayed")===0)
            {
                var dropdown = '<select class="form-control" name="general_dropdown" id="cars"'+'>'+
                '<option value="Not Started">Not Started</option'+'>'+
                '<option value="In Progress">In Progress</option'+'>'+
                '<option selected="selected" value="Delayed">Delayed</option'+'>'+
                '<option value="Completed">Completed</option'+'>'+'</select>';
            }
            else
            {
                var dropdown = '<select class="form-control" name="general_dropdown" id="cars"'+'>'+
                '<option selected="selected" value="Not Started">Not Started</option'+'>'+
                '<option value="In Progress">In Progress</option'+'>'+
                '<option value="Delayed">Delayed</option'+'>'+
                '<option value="Completed">Completed</option'+'>'+'</select>';
            }            
            return dropdown;
        }

        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////// make_date_selector FUNC ////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        
        function make_date_selector(date)
        {
            console.log(date);
            var bits = date.split(/\D/);
            // console.log(bits[0],bits[1],bits[2],bits[3],bits[4]);
            var datef = new Date(bits[0], --bits[1], bits[2], bits[3], bits[4]);
            console.log(datef);
            
            var day = ("0" + datef.getDate()).slice(-2);
            var month = ("0" + (datef.getMonth() + 1)).slice(-2);

            var datef = datef.getFullYear()+"-"+(month)+"-"+(day) ;

            if(date.localeCompare('')===0)
            {
                var datepicker = '<input type="date" data-date-format="mm/dd/yyyy">';
            }
            else
            {
                var datepicker = '<input type="date" data-date-format="mm/dd/yyyy" value="'+datef+'">';
            }
            return datepicker
        }

        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////// load_data FUNC /////////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        function load_data(obj)
        {

            // console.log("\n=================\nLOADING DATA\n========================\n",obj); 
            /*
            *looping over columns
            */
            var cols = Object.keys(obj)
            cols.forEach(function(item)
            {
                // console.log(item);
            });

            var employee_data='';
            employee_data += '<tr>';
            employee_data += '<td><button class="btn btn-danger" onclick="delete_row(this)"/>-</button></td>';
            employee_data += '<td contenteditable="true">'+obj.customer_name+'</td>';
            employee_data += '<td contenteditable="true">'+obj.product_name+'</td>';
            employee_data += '<td>'+make_drop_down(obj.codes)+'</td>';
            
            employee_data += '<td>'+make_date_selector(obj.code_date)+'</td>';
            console.log("design")
            employee_data += '<td>'+make_drop_down(obj.design)+'</td>';

            employee_data += '<td>'+make_date_selector(obj.design_date)+'</td>';
            
            console.log("design_approval")
            employee_data += '<td>'+make_drop_down(obj.design_approval)+'</td>';

            employee_data += '<td>'+make_date_selector(obj.design_approval_date)+'</td>';

            console.log("send_to_printer")
            employee_data += '<td>'+make_drop_down(obj.send_to_printer)+'</td>';

            employee_data += '<td>'+make_date_selector(obj.send_to_printer_date)+'</td>';

            console.log("proof_approval")
            employee_data += '<td>'+make_drop_down(obj.proof_approval)+'</td>';

            employee_data += '<td>'+make_date_selector(obj.proof_approval_date)+'</td>';

            console.log("shipping")
            employee_data += '<td>'+make_drop_down(obj.shipping)+'</td>';

            employee_data += '<td>'+make_date_selector(obj.ship_date)+'</td>';

            console.log("received")
            employee_data += '<td>'+make_drop_down(obj.received)+'</td>';

            employee_data += '<td>'+make_date_selector(obj.received_date)+'</td>';

            console.log("completed")
            employee_data += '<td>'+make_drop_down(obj.completed)+'</td>';

            employee_data += '<td>'+obj.files+'</td>';

            employee_data += '<td>'+obj.notes+'</td></tr>';
            
            $('#mtable').append(employee_data);
        }

        const Http = new XMLHttpRequest();
        const url='http://localhost:3000/home/orders';
        Http.open("GET", url);
        Http.send();

        Http.onload = (e) => {
            var Data = JSON.parse(Http.responseText);
            console.log("\n=================\nLOADED DATA\n========================\n",Data); 
            user_identity = Data[0].user_id;
            $('#storename')[0].src = Data[Data.length-1].store_logo_path;
            $('#storename')[0].alt = Data[Data.length-1].store_logo;
            for(var i = 0; i < Data.length - 1; i++) {
                var obj = Data[i];
                load_data(obj);              
            }
            // $('#mtable').DataTable();
        }

        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////// check datatype of col /////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        function check_dtype(element)
        {
            var type = element.prop("tagName");
            if(type.localeCompare("TD")===0)
            {
                return "text";
            }
            else if(type.localeCompare("SELECT")===0)
            {
                return "dropdown"
            }
            else if(type.localeCompare("INPUT")===0)
            {
                return "date"
            }

        }

        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////// Submit data of table //////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        function submit()
        {
            var keys=[], arrayObj=[], datatypes={};
            $("#mtable thead tr th").each(function(){
                keys.push($(this).text());
            });
            
            for (let i = 0; i < keys.length; i++) {
                keys[i] = keys[i].replace(/ /g,"_");
                //Do something
            }

            var cust_index = keys.indexOf("Customer");
            var prod_index = keys.indexOf("Product");
            if (cust_index !== -1) {
                keys[cust_index] = "customer_name";
            }
            if (prod_index !== -1) {
                keys[prod_index] = "product_name";
            }

            keys = keys.map(name => name.toLowerCase());

            console.log("keys: ",keys);

            rows_count=0;
            $("#mtable tbody tr").each(function(){
                var obj={}, i=0;
                $(this).children("td").each(function(){
                
                //to get drop down val AND (date value iff set)
                if($(this).children().first().val())
                {
                    obj['sr_no'] = rows_count;
                    obj[keys[i]] = $(this).children().first().val();
                    //to get datatype of col
                    //we will take datatype only for first row others have same data type
                    if(rows_count===0)
                    {
                        datatypes[keys[i]]=(check_dtype($(this).children().first()));
                    }

                }
                else //get text inside cell
                {
                    obj['sr_no'] = rows_count;
                    obj[keys[i]] = $(this).text();
                    //to get datatype of col
                    if(rows_count===0)
                    {
                        datatypes[keys[i]]=(check_dtype($(this)));
                    }
                }
                i++;
                })
                obj['user_id'] = user_identity;
                rows_count++;
                arrayObj.push(obj);
            });
            
            console.log("\n-------------------------------------\ndatatypes: \n",datatypes);
            var data = {table_data: arrayObj, data_types: datatypes}
            console.log("\n-------------------------------------\nRETURNED DATA \n",data);

            $.post("http://localhost:3000/home/orders/save",data,
            function(data,status){
                alert("Data is saved !")
            });
        }

        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////// Change color of dropdown //////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        function ondropdownchange(col)
        {

        }
    </script>

</body>

</html>